# Petkit T4 ESPHome Firmware
# Refactored for better organization and new features
# by Sdore, 2024-25 | Refactored 2025
#   www.sdore.me

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Core ESPHome Configuration
# ═══════════════════════════════════════════════════════════════════════════════

dashboard_import:
  package_import_url: github://egormanga/esphome-petkit-t4/petkit.yml

esphome:
  name: petkit-t4
  friendly_name: Petkit T4
  project:
    name: egormanga.esphome-petkit-t4
    version: 0.11.0
  platformio_options:
    board_upload.maximum_size: 0x800000

external_components:
  - source: ./components
  - source: github://egormanga/esphome-bm8563

esp32:
  board: esp32dev
  flash_size: 8MB

logger:
  hardware_uart: UART1
  baud_rate: 0  # disable

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password
  on_state_change:
    - pkt4_mcu.motor:
        motor: drum
        mode: stop
    - globals.set:
        id: ota_state
        value: !lambda return state;
    - component.update: oled

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Network Configuration
# ═══════════════════════════════════════════════════════════════════════════════

wifi:
  id: wifi_
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true
  ap:
    ssid: !secret ap_ssid
    password: !secret ap_password
  power_save_mode: none
  on_connect:
    - if:
        condition:
          lambda: return !id(is_quiet_time);
        then:
          rtttl.play: :d=16,o=6,b=100:e,g
  on_disconnect:
    - if:
        condition:
          lambda: return !id(is_quiet_time);
        then:
          rtttl.play: :d=16,o=6,b=100:g,e

captive_portal:

substitutions:
  ap_ssid: !secret ap_ssid
  ap_password: !secret ap_password

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Hardware Peripherals
# ═══════════════════════════════════════════════════════════════════════════════

uart:
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 115200
  debug:
    direction: TX
    after:
      bytes: 0x100
      timeout: 10ms
    sequence:
      lambda: UARTDebug::log_hex(direction, bytes, ' ');

power_supply:
  - id: vreg_display
    pin:
      number: GPIO2
      ignore_strapping_warning: true
    enable_on_boot: true

  - id: vreg_bus
    pin: GPIO26
    enable_on_boot: true

  - id: vreg_bus_rev2
    pin: GPIO27
    enable_on_boot: true

output:
  - platform: ledc
    id: beeper
    pin: GPIO16

i2c:
  sda:
    number: GPIO15
    ignore_strapping_warning: true
  scl: GPIO4
  scan: false

spi:
  mosi_pin: GPIO23
  clk_pin: GPIO18

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Time Management
# ═══════════════════════════════════════════════════════════════════════════════

time:
  - platform: bm8563
    id: rtc_time

  - platform: homeassistant
    id: ha_time
    on_time_sync:
      bm8563.write_time:
    on_time:
      # Check quiet mode every minute and process deferred cleans when quiet ends
      - seconds: 0
        then:
          - lambda: |-
              auto now = id(ha_time).now();
              if (!now.is_valid()) return;
              int current_hour = now.hour;
              int start = (int)id(quiet_start_hour).state;
              int end = (int)id(quiet_end_hour).state;
              
              // Calculate if we're currently in quiet hours
              bool in_quiet;
              if (start <= end) {
                in_quiet = (current_hour >= start && current_hour < end);
              } else {
                in_quiet = (current_hour >= start || current_hour < end);
              }
              
              // Store previous state to detect transition
              bool was_quiet = id(is_quiet_time);
              id(is_quiet_time) = (id(quiet_mode_enabled).state && in_quiet);
              
              // Check if quiet time just ended (transition from quiet to not quiet)
              if (was_quiet && !id(is_quiet_time) && id(deferred_cleans) > 0) {
                // Trigger deferred clean processing via script
                id(process_deferred_cleans).execute();
              }
      # Reset daily visit counts at midnight
      - hours: 0
        minutes: 0
        seconds: 0
        then:
          - lambda: |-
              for (int i = 0; i < 4; i++) {
                id(pet_visits_today)[i] = 0;
              }

rtttl:
  output: beeper
  gain: 50%

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Display Resources
# ═══════════════════════════════════════════════════════════════════════════════

qr_code:
  id: qrcode_ap
  value: "WIFI:S:${ap_ssid};T:WPA;P:${ap_password};;"

font:
  id: font_weight
  file:
    type: gfonts
    family: Ubuntu Mono
  size: 48

image:
  - id: icon_logo
    file: mdi:inbox
    type: binary
    resize: 96x96

  - id: icon_clean
    file: mdi:recycle
    type: binary
    resize: 96x96

  - id: icon_maintenance
    file: mdi:progress-wrench
    type: binary
    resize: 96x96

  - id: icon_level
    file: mdi:spirit-level
    type: binary
    resize: 96x96

  - id: icon_tray
    file: mdi:tray-alert
    type: binary
    resize: 96x96

  - id: icon_auto_clean
    file: mdi:recycle-variant
    type: binary
    resize: 96x96

  - id: icon_problem
    file: mdi:alert
    type: binary
    resize: 96x96

  - id: icon_tray_full
    file: mdi:tray-full
    type: binary
    resize: 96x96

  - id: icon_ota
    file: mdi:progress-download
    type: binary
    resize: 96x96

  - id: icon_weight
    file: mdi:weight-kilogram
    type: binary
    resize: 64x64

  - id: icon_waste
    file: mdi:liquid-spot
    type: binary
    resize: 64x64

  - id: icon_quiet
    file: mdi:volume-off
    type: binary
    resize: 96x96

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Display Output
# ═══════════════════════════════════════════════════════════════════════════════

display:
  platform: ssd1306_spi
  id: oled
  model: 'SH1107 128x128'
  cs_pin:
    number: GPIO5
    ignore_strapping_warning: true
  dc_pin: GPIO19
  reset_pin: GPIO17
  data_rate: 40MHz
  external_vcc: true
  rotation: 180°
  update_interval: 0.01s
  lambda: |-
    static uint16_t clip = 0;
    
    // OTA update screen
    if (id(ota_state)) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_ota), ImageAlign::CENTER);
      return;
    }
    
    // Cleaning or maintenance animation
    if (id(clean).state || (id(maintenance).state && millis() % 5000 < 1500) || (id(level_needed) && !id(maintenance).state)) {
      BaseImage *icon;
      if (id(approach).state) icon = id(icon_problem);
      else if (id(clean).state) icon = id(icon_clean);
      else if (id(maintenance).state) icon = id(icon_maintenance);
      else if (id(level_needed)) icon = id(icon_level);
      else return;
      
      it.start_clipping((it.get_width() - icon->get_width())/2 + (clip < icon->get_width() ? clip : 0), 0, 
                        clip >= icon->get_width() ? ((it.get_width() - icon->get_width())/2 + max(0, (int)(clip - icon->get_width()))) : it.get_width(), 
                        it.get_height());
      if ((clip += 2) > icon->get_width() * 2) clip = 0;
      it.image(it.get_width()/2, it.get_height()/2, icon, ImageAlign::CENTER);
      return;
    }
    
    // Waste collected display after cleaning
    if (id(cleaned_at) && millis() - id(cleaned_at) < 10000) {
      it.image(it.get_width()/2, (it.get_height() - id(icon_waste).get_height())/2, id(icon_waste), ImageAlign::CENTER);
      it.printf(it.get_width()/2, it.get_height(), id(font_weight), TextAlign::BOTTOM_CENTER, "%.0f", id(waste_collected) * 1000);
      clip = 0;
      return;
    }
    
    // Tray full warning
    if (id(tray_full).state && millis() % 5000 < 1000) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_tray_full), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // Quiet mode indicator
    if (id(is_quiet_time) && millis() % 5000 < 1000) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_quiet), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // Pending clean indicator
    if (id(clean_pending).state && millis() % 5000 < 2000) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_auto_clean), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // Maintenance mode or pet weight display
    if (id(maintenance).state || id(pet_weight).state > 0.01f) {
      it.image(it.get_width()/2, (it.get_height() - id(icon_weight).get_height())/2, id(icon_weight), ImageAlign::CENTER);
      it.printf(it.get_width()/2, it.get_height(), id(font_weight), TextAlign::BOTTOM_CENTER, "%.2f", 
                id(maintenance).state ? id(weight).state - id(waste_collected) : id(pet_weight).state);
      clip = 0;
      return;
    }
    
    // Problem indicators
    if (id(cover).state || id(bin).state || id(approach).state) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_problem), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // Tray alert
    if (id(tray).state) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_tray), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // Boot logo
    if (id(sensor_uptime).state < 10) {
      it.image(it.get_width()/2, it.get_height()/2, id(icon_logo), ImageAlign::CENTER);
      clip = 0;
      return;
    }
    
    // WiFi QR code when disconnected
    if (!id(wifi_).is_connected()) {
      static uint8_t ii = 0;
      uint8_t scale = (min(it.get_width(), it.get_height()) / id(qrcode_ap).get_size());
      it.qr_code((++ii/8 % (it.get_width() - id(qrcode_ap).get_size()*scale)), 
                 (ii/8 / (it.get_height() - id(qrcode_ap).get_size()*scale)), 
                 id(qrcode_ap), COLOR_ON, scale);
    }
    
    clip = 0;

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Global Variables
# ═══════════════════════════════════════════════════════════════════════════════

globals:
  # --- Weight Calibration ---
  - id: weight_zero
    type: int
    initial_value: '7975680'
    restore_value: true

  - id: weight_scale
    type: float
    initial_value: '-1/65536.f'
    restore_value: true

  - id: auto_tare_enabled
    type: bool
    initial_value: 'true'
    restore_value: true

  # --- Litter Management ---
  - id: litter_mass
    type: float
    restore_value: true

  - id: waste_collected
    type: float
    restore_value: true

  - id: litter_discarded
    type: float
    restore_value: true

  - id: waste_pending
    type: float

  - id: total_cleans
    type: int
    restore_value: true

  - id: cleans_since_refill
    type: int
    restore_value: true

  # --- Cleaning State ---
  - id: cleans_left
    type: int

  - id: level_needed
    type: bool

  - id: cleaned_at
    type: long

  - id: ota_state
    type: int

  # --- Quiet Mode ---
  - id: is_quiet_time
    type: bool
    initial_value: 'false'

  - id: deferred_cleans
    type: int
    initial_value: '0'

  # --- Multi-Pet Tracking (4 pets max) ---
  - id: pet_weight_min
    type: float[4]
    restore_value: true
    initial_value: '{1.0f, 3.0f, 5.0f, 7.0f}'

  - id: pet_weight_max
    type: float[4]
    restore_value: true
    initial_value: '{3.0f, 5.0f, 7.0f, 15.0f}'

  - id: pet_visit_count
    type: int[4]
    restore_value: true
    initial_value: '{0, 0, 0, 0}'

  - id: pet_visits_today
    type: int[4]
    initial_value: '{0, 0, 0, 0}'

  - id: pet_last_weight
    type: float[4]
    restore_value: true
    initial_value: '{0.0f, 0.0f, 0.0f, 0.0f}'

  - id: pet_weight_sum
    type: float[4]
    restore_value: true
    initial_value: '{0.0f, 0.0f, 0.0f, 0.0f}'

  - id: pet_weight_count
    type: int[4]
    restore_value: true
    initial_value: '{0, 0, 0, 0}'

  - id: current_pet_id
    type: int
    initial_value: '-1'

  - id: visit_start_time
    type: long

  - id: last_valid_pet_mass
    type: float
    initial_value: '0.0f'

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: MCU Component
# ═══════════════════════════════════════════════════════════════════════════════

pkt4_mcu:
  id: mcu

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Hardware Sensors
# ═══════════════════════════════════════════════════════════════════════════════

sensor:
  # --- MCU Sensors ---
  - platform: pkt4_mcu
    distance:
      name: Distance
      entity_category: diagnostic
      disabled_by_default: true
      filters:
        - calibrate_polynomial:
            degree: 3
            datapoints:
              - 8192 -> 0
              - 1024 -> 1
              - 256 -> 5
              - 32 -> 10
        - clamp:
            max_value: 10
        - delta: 0.5

    weight:
      id: weight
      name: Weight
      icon: mdi:scale
      entity_category: diagnostic
      disabled_by_default: true
      filters:
        - offset: !lambda return -id(weight_zero);
        - multiply: !lambda return id(weight_scale);
        - delta: 0.005
      on_value:
        - lambda: |-
            // Auto-tare when conditions are right
            if (id(auto_tare_enabled) && 
                !id(maintenance).state && 
                !id(clean).state &&
                id(drum_level).state &&
                !id(tray).state &&
                !id(cover).state &&
                !id(bin).state &&
                id(pet_weight).state < 0.05f) {
              // Check stability - raw value should be stable
              static int stable_count = 0;
              static float last_raw = 0;
              float current_raw = id(weight).raw_state;
              if (abs(current_raw - last_raw) < 1000) {
                stable_count++;
                // Use threshold comparison for floats (not exact == 0)
                if (stable_count >= 10 && 
                    fabs(id(litter_mass)) < 0.001f && 
                    fabs(id(waste_collected)) < 0.001f) {
                  // Auto-tare when empty and stable
                  id(weight_zero) = (int)current_raw;
                  ESP_LOGI("auto_tare", "Auto-tare complete: zero=%d", id(weight_zero));
                  stable_count = 0;
                }
              } else {
                stable_count = 0;
              }
              last_raw = current_raw;
            }
      on_value_range:
        - above: !lambda return (id(waste_collected) + id(litter_threshold).state);
          then:
            - if:
                condition:
                  - switch.is_on: maintenance
                  - lambda: return !id(is_quiet_time);
                then:
                  rtttl.play: :d=32,o=6,b=100:g,64p,g,64p,g

  # --- Diagnostic Sensors ---
  - platform: adc
    name: 3V3
    entity_category: diagnostic
    disabled_by_default: true
    pin: GPIO32
    attenuation: 12dB
    filters:
      multiply: 16

  - platform: pulse_counter
    id: mcu_interrupts
    pin:
      number: GPIO22
      allow_other_uses: true
    internal_filter: 0s
    total:
      name: MCU Interrupts
      entity_category: diagnostic
      disabled_by_default: true

  - platform: uptime
    id: sensor_uptime
    name: Uptime
    icon: mdi:clock-start
    entity_category: diagnostic
    disabled_by_default: true

  # --- Pet Weight Sensors ---
  - platform: template
    id: pet_weight
    name: Pet Weight
    icon: mdi:paw
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 1s
    lambda: return (max(0.f, id(weight).state) - id(litter_mass) - id(waste_collected));
    on_value_range:
      above: !lambda return id(clean_threshold).state / 1000.f;
      below: !lambda return id(pet_threshold).state;
      then:
        - if:
            condition:
              lambda: return id(cleans_left) <= 0;
            then:
              globals.set:
                id: cleans_left
                value: !lambda return id(clean_times).state;

  - platform: template
    id: pet_mass
    unit_of_measurement: kg
    internal: true
    lambda: |-
      if (id(pet_inside).state) return id(pet_weight).state;
      else return {};
    update_interval: 1s
    filters:
      quantile:
    on_value:
      - lambda: |-
          // Store valid mass readings for use after pet exits
          if (!isnan(x) && x > 0.1f) {
            id(last_valid_pet_mass) = x;
          }

  - platform: template
    id: pet_body_mass
    name: Pet Body Mass
    icon: mdi:scale-bathroom
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 1
    update_interval: never
    lambda: return (id(pet_mass).state - id(pet_weight).state);
    filters:
      - clamp:
          min_value: 0
      - filter_out: 0

  # --- Litter Management Sensors ---
  - platform: template
    name: Litter Mass
    icon: mdi:bucket
    unit_of_measurement: g
    device_class: weight
    state_class: measurement
    accuracy_decimals: 0
    update_interval: 1s
    lambda: return id(litter_mass) * 1000;

  - platform: template
    name: Waste Collected
    icon: mdi:liquid-spot
    unit_of_measurement: g
    device_class: weight
    state_class: measurement
    accuracy_decimals: 0
    update_interval: 1s
    lambda: return id(waste_collected) * 1000;

  - platform: template
    name: Litter Discarded
    icon: mdi:delete-variant
    unit_of_measurement: kg
    device_class: weight
    state_class: total_increasing
    accuracy_decimals: 2
    update_interval: 1s
    lambda: return id(litter_discarded);

  - platform: template
    id: cleans_remaining_sensor
    name: Cleans Remaining
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: measurement
    update_interval: 60s
    lambda: |-
      if (id(cleans_since_refill) == 0 || id(waste_collected) < 0.01f) return 0;
      float avg_waste_per_clean = id(waste_collected) / id(cleans_since_refill);
      if (avg_waste_per_clean < 0.01f) return 0;
      float remaining_capacity = id(tray_capacity).state - id(waste_collected);
      return (int)(remaining_capacity / avg_waste_per_clean);

  - platform: template
    name: Cleans Left
    icon: mdi:counter
    accuracy_decimals: 0
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 1s
    lambda: return id(cleans_left);

  - platform: template
    name: Total Cleans
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: total_increasing
    update_interval: 60s
    lambda: return id(total_cleans);

  # --- Pet Statistics Sensors ---
  - platform: template
    id: current_pet_sensor
    name: Current Pet ID
    icon: mdi:cat
    accuracy_decimals: 0
    entity_category: diagnostic
    update_interval: 1s
    lambda: return id(current_pet_id) + 1;  # 0 = no pet, 1-4 = pet ID

  - platform: template
    id: pet_1_visits_today
    name: Pet 1 Visits Today
    icon: mdi:paw
    accuracy_decimals: 0
    state_class: total_increasing
    update_interval: 60s
    lambda: return id(pet_visits_today)[0];

  - platform: template
    id: pet_1_total_visits
    name: Pet 1 Total Visits
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: total_increasing
    update_interval: 60s
    lambda: return id(pet_visit_count)[0];

  - platform: template
    id: pet_1_avg_weight
    name: Pet 1 Average Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      if (id(pet_weight_count)[0] == 0) return 0.0f;
      return id(pet_weight_sum)[0] / id(pet_weight_count)[0];

  - platform: template
    id: pet_1_last_weight
    name: Pet 1 Last Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 60s
    lambda: return id(pet_last_weight)[0];

  - platform: template
    id: pet_2_visits_today
    name: Pet 2 Visits Today
    icon: mdi:paw
    accuracy_decimals: 0
    state_class: total_increasing
    update_interval: 60s
    lambda: return id(pet_visits_today)[1];

  - platform: template
    id: pet_2_total_visits
    name: Pet 2 Total Visits
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: total_increasing
    update_interval: 60s
    lambda: return id(pet_visit_count)[1];

  - platform: template
    id: pet_2_avg_weight
    name: Pet 2 Average Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      if (id(pet_weight_count)[1] == 0) return 0.0f;
      return id(pet_weight_sum)[1] / id(pet_weight_count)[1];

  - platform: template
    id: pet_2_last_weight
    name: Pet 2 Last Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 60s
    lambda: return id(pet_last_weight)[1];

  - platform: template
    id: pet_3_visits_today
    name: Pet 3 Visits Today
    icon: mdi:paw
    accuracy_decimals: 0
    state_class: total_increasing
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_visits_today)[2];

  - platform: template
    id: pet_3_total_visits
    name: Pet 3 Total Visits
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: total_increasing
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_visit_count)[2];

  - platform: template
    id: pet_3_last_weight
    name: Pet 3 Last Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_last_weight)[2];

  - platform: template
    id: pet_4_visits_today
    name: Pet 4 Visits Today
    icon: mdi:paw
    accuracy_decimals: 0
    state_class: total_increasing
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_visits_today)[3];

  - platform: template
    id: pet_4_total_visits
    name: Pet 4 Total Visits
    icon: mdi:counter
    accuracy_decimals: 0
    state_class: total_increasing
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_visit_count)[3];

  - platform: template
    id: pet_4_last_weight
    name: Pet 4 Last Weight
    icon: mdi:scale
    unit_of_measurement: kg
    device_class: weight
    state_class: measurement
    accuracy_decimals: 2
    entity_category: diagnostic
    disabled_by_default: true
    update_interval: 60s
    lambda: return id(pet_last_weight)[3];

  - platform: template
    name: Deferred Cleans
    icon: mdi:clock-outline
    accuracy_decimals: 0
    entity_category: diagnostic
    update_interval: 10s
    lambda: return id(deferred_cleans);

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Binary Sensors
# ═══════════════════════════════════════════════════════════════════════════════

binary_sensor:
  # --- MCU Binary Sensors ---
  - platform: pkt4_mcu
    approach:
      id: approach
      name: Approach
      entity_category: diagnostic
      filters:
        delayed_off: 5s
      on_press:
        - if:
            condition:
              switch.is_off: maintenance
            then:
              script.execute: emergency_stop
      on_release:
        - if:
            condition:
              lambda: return id(pet_weight).state * 1000 > id(pet_threshold).state;
            then:
              component.update: pet_body_mass
        - script.execute: auto_clean

    bin:
      id: bin
      name: Bin
      entity_category: diagnostic
      on_press:
        - if:
            condition:
              switch.is_off: maintenance
            then:
              pkt4_mcu.motor:
                motor: tray
                mode: stop
        - if:
            all:
              - binary_sensor.is_off: cover
              - not:
                  binary_sensor.is_on: tray
            then:
              pkt4_mcu.motor:
                motor: tray
                direction: open
                speed: 50
                mode: time
                timeout: 80
      on_release:
        - delay: 5s
        - if:
            all:
              - binary_sensor.is_off: bin
              - binary_sensor.is_off: cover
            then:
              - globals.set:
                  id: waste_collected
                  value: !lambda return max(0.f, (max(0.f, id(weight).state) - id(litter_mass)));
              - globals.set:
                  id: litter_discarded
                  value: !lambda return (id(litter_discarded) + max(0.f, (id(litter_mass) - max(0.f, id(weight).state))));
              - globals.set:
                  id: litter_mass
                  value: !lambda return max(0.f, (max(0.f, id(weight).state) - id(waste_collected)));
              - script.execute: level_if_needed

    cover:
      id: cover
      name: Cover
      entity_category: diagnostic
      on_press:
        - pkt4_mcu.motor:
            motor: drum
            mode: stop
        - pkt4_mcu.motor:
            motor: tray
            mode: stop
      on_release:
        script.execute: level_if_needed

    drum_up:
      id: drum_up
      name: Drum Up
      entity_category: diagnostic
      on_press:
        - pkt4_mcu.motor:
            motor: drum
            mode: stop
        - switch.turn_off: motor_drum_up
        - if:
            all:
              - binary_sensor.is_off: pet_inside
              - binary_sensor.is_off: cover
            then:
              - globals.set:
                  id: waste_collected
                  value: !lambda return min(id(waste_pending), max(0.f, (max(0.f, id(weight).state) - id(litter_mass))));
              - globals.set:
                  id: total_cleans
                  value: !lambda return id(total_cleans) + 1;
              - globals.set:
                  id: cleans_since_refill
                  value: !lambda return id(cleans_since_refill) + 1;
        - script.execute: level_if_needed

    drum_down:
      id: drum_down
      name: Drum Down
      entity_category: diagnostic
      on_press:
        - pkt4_mcu.motor:
            motor: drum
            mode: stop
        - switch.turn_off: motor_drum_down
        - if:
            condition:
              switch.is_on: clean
            then:
              switch.turn_off: clean
        - if:
            condition:
              switch.is_on: maintenance
            then:
              switch.turn_off: maintenance
        - globals.set:
            id: level_needed
            value: 'true'
        - if:
            condition:
              binary_sensor.is_off: cover
            then:
              pkt4_mcu.motor:
                motor: drum
                direction: up
                speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                mode: time
                timeout: 150

    drum_level:
      id: drum_level
      name: Drum Level
      entity_category: diagnostic
      publish_initial_state: true
      on_press:
        globals.set:
          id: level_needed
          value: 'true'
      on_release:
        - if:
            all:
              - switch.is_off: clean
              - switch.is_off: maintenance
            then:
              - pkt4_mcu.motor:
                  motor: drum
                  mode: stop
              - switch.turn_off: motor_drum_up
              - switch.turn_off: motor_drum_down
              - if:
                  all:
                    - binary_sensor.is_off: cover
                    - binary_sensor.is_on: tray
                    - binary_sensor.is_off: bin
                  then:
                    pkt4_mcu.motor:
                      motor: tray
                      direction: close
                      speed: 5
                      mode: time
                      timeout: 80
        - globals.set:
            id: level_needed
            value: 'false'
        - script.execute: auto_clean

    tray:
      id: tray
      name: Tray
      entity_category: diagnostic
      disabled_by_default: true
      publish_initial_state: true
      on_state:
        pkt4_mcu.motor:
          motor: tray
          mode: stop
      on_press:
        - if:
            condition:
              switch.is_on: clean
            then:
              switch.turn_on: clean
            else:
              - if:
                  condition:
                    switch.is_on: maintenance
                  then:
                    switch.turn_on: maintenance
                  else:
                    script.execute: level_if_needed
      on_release:
        script.execute: level_if_needed

  # --- Derived Binary Sensors ---
  - platform: template
    id: pet_inside
    name: Pet Inside
    icon: mdi:paw
    device_class: problem
    entity_category: diagnostic
    condition:
      all:
        - switch.is_off: maintenance
        - lambda: return id(pet_weight).state >= id(pet_threshold).state;
    filters:
      delayed_off: 5s
    on_press:
      - script.execute: emergency_stop
      - script.execute: pet_entered
    on_release:
      - script.execute: pet_exited
      - script.execute: auto_clean

  - platform: template
    id: tray_full
    name: Tray Full
    icon: mdi:tray-full
    device_class: problem
    entity_category: diagnostic
    lambda: return id(waste_collected) >= id(tray_capacity).state;

  - platform: template
    name: Level Needed
    icon: mdi:compare-horizontal
    device_class: problem
    entity_category: diagnostic
    lambda: return id(level_needed);

  - platform: template
    id: clean_pending
    name: Clean Pending
    icon: mdi:recycle-variant
    device_class: running
    entity_category: diagnostic
    condition:
      script.is_running: clean_if_needed

  - platform: template
    id: litter_low
    name: Litter Low
    icon: mdi:bucket-outline
    device_class: problem
    lambda: |-
      if (id(cleans_since_refill) == 0) return false;
      float avg_waste = id(waste_collected) / id(cleans_since_refill);
      float remaining = id(tray_capacity).state - id(waste_collected);
      return (remaining < avg_waste * 3);  # Low if less than 3 cleans remaining

  - platform: template
    name: Quiet Mode Active
    icon: mdi:volume-off
    entity_category: diagnostic
    lambda: return id(is_quiet_time);

  # --- Physical Buttons ---
  - platform: gpio
    name: Menu Button
    entity_category: diagnostic
    pin:
      number: GPIO34
      inverted: true
    on_double_click:
      - if:
          condition:
            switch.is_off: maintenance
          then:
            switch.turn_on: maintenance
    on_multi_click:
      timing:
        - ON for at least 2s
      then:
        button.press: reboot

  - platform: gpio
    name: OK Button
    entity_category: diagnostic
    pin:
      number: GPIO0
      inverted: true
      ignore_strapping_warning: true
    on_click:
      button.press: level

  - platform: gpio
    name: MCU
    entity_category: diagnostic
    disabled_by_default: true
    pin:
      number: GPIO22
      allow_other_uses: true
    publish_initial_state: true
    on_press:
      pkt4_mcu.init:
    on_release:
      pkt4_mcu.deinit:

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Buttons
# ═══════════════════════════════════════════════════════════════════════════════

button:
  - platform: template
    id: level
    name: Level
    icon: mdi:spirit-level
    on_press:
      - if:
          condition:
            switch.is_on: maintenance
          then:
            switch.turn_off: maintenance
          else:
            - switch.turn_off: clean
            - globals.set:
                id: level_needed
                value: 'true'
            - script.execute: level_if_needed

  - platform: template
    name: All Litter Removed
    icon: mdi:delete-empty
    entity_category: config
    on_press:
      - if:
          condition:
            binary_sensor.is_off: cover
          then:
            - globals.set:
                id: litter_mass
                value: '0'
            - globals.set:
                id: waste_collected
                value: '0'
            - globals.set:
                id: cleans_since_refill
                value: '0'

  - platform: template
    name: Weight Calibration Zero
    icon: mdi:scale-balance
    entity_category: config
    on_press:
      - if:
          condition:
            binary_sensor.is_off: cover
          then:
            globals.set:
              id: weight_zero
              value: !lambda return id(weight).raw_state;

  - platform: template
    name: Reset Pet Statistics
    icon: mdi:refresh
    entity_category: config
    on_press:
      - lambda: |-
          for (int i = 0; i < 4; i++) {
            id(pet_visit_count)[i] = 0;
            id(pet_visits_today)[i] = 0;
            id(pet_last_weight)[i] = 0.0f;
            id(pet_weight_sum)[i] = 0.0f;
            id(pet_weight_count)[i] = 0;
          }

  - platform: restart
    name: Restart
    id: reboot
    entity_category: diagnostic

  - platform: safe_mode
    name: Restart Safe Mode
    entity_category: diagnostic
    disabled_by_default: true

  - platform: factory_reset
    name: Factory Reset
    entity_category: config
    disabled_by_default: true

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Switches
# ═══════════════════════════════════════════════════════════════════════════════

switch:
  # --- Main Operation Switches ---
  - platform: template
    id: clean
    name: Clean
    icon: mdi:recycle
    optimistic: true
    restore_mode: disabled
    turn_on_action:
      - if:
          all:
            - switch.is_off: maintenance
            - binary_sensor.is_off: approach
            - binary_sensor.is_off: pet_inside
            - binary_sensor.is_off: cover
            - binary_sensor.is_off: bin
            - binary_sensor.is_off: drum_up
          then:
            - if:
                condition:
                  not:
                    binary_sensor.is_on: tray
                then:
                  pkt4_mcu.motor:
                    motor: tray
                    direction: open
                    speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                    mode: time
                    timeout: 80
                else:
                  - script.stop: clean_if_needed
                  - globals.set:
                      id: waste_pending
                      value: !lambda return max(0.f, (max(0.f, id(weight).state) - id(litter_mass)));
                  - globals.set:
                      id: level_needed
                      value: 'true'
                  - pkt4_mcu.motor:
                      motor: drum
                      direction: up
                      speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                      mode: time
                      timeout: 1000
          else:
            - delay: 0s
            - switch.turn_off: clean
    turn_off_action:
      - pkt4_mcu.motor:
          motor: drum
          mode: stop
      - pkt4_mcu.motor:
          motor: tray
          direction: close
          speed: 5
          mode: time
          timeout: 80
    on_turn_off:
      globals.set:
        id: cleaned_at
        value: !lambda return millis();

  - platform: template
    id: maintenance
    name: Maintenance
    icon: mdi:progress-wrench
    optimistic: true
    restore_mode: disabled
    turn_on_action:
      - if:
          all:
            - switch.is_off: clean
            - binary_sensor.is_off: cover
            - binary_sensor.is_off: bin
            - binary_sensor.is_off: drum_up
            - binary_sensor.is_off: drum_level
          then:
            - globals.set:
                id: level_needed
                value: 'true'
            - if:
                condition:
                  not:
                    binary_sensor.is_on: tray
                then:
                  pkt4_mcu.motor:
                    motor: tray
                    direction: open
                    speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                    mode: time
                    timeout: 80
                else:
                  pkt4_mcu.motor:
                    motor: drum
                    direction: up
                    speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                    mode: time
                    timeout: 120
          else:
            - delay: 0s
            - switch.turn_off: maintenance
    turn_off_action:
      - pkt4_mcu.motor:
          motor: drum
          mode: stop
      - if:
          condition:
            binary_sensor.is_off: cover
          then:
            globals.set:
              id: litter_mass
              value: !lambda return max(0.f, (max(0.f, id(weight).state) - id(waste_collected)));
      - script.execute: level_if_needed

  # --- Auto Clean Switch ---
  - platform: template
    id: do_auto_clean
    name: Auto Clean
    icon: mdi:refresh-auto
    entity_category: config
    optimistic: true
    restore_mode: restore_default_off
    on_turn_on:
      script.execute: auto_clean

  # --- Quiet Mode Switch ---
  - platform: template
    id: quiet_mode_enabled
    name: Quiet Mode
    icon: mdi:volume-off
    entity_category: config
    optimistic: true
    restore_mode: restore_default_off

  # --- Auto Tare Switch ---
  - platform: template
    name: Auto Tare
    icon: mdi:scale-balance
    entity_category: config
    optimistic: true
    restore_mode: restore_default_on
    lambda: return id(auto_tare_enabled);
    turn_on_action:
      globals.set:
        id: auto_tare_enabled
        value: 'true'
    turn_off_action:
      globals.set:
        id: auto_tare_enabled
        value: 'false'

  # --- Motor Control Switches ---
  - platform: template
    id: motor_tray
    name: Tray
    icon: mdi:stack-overflow
    entity_category: diagnostic
    optimistic: false
    restore_mode: disabled
    lambda: return id(tray).state;
    turn_on_action:
      - if:
          condition:
            binary_sensor.is_off: cover
          then:
            pkt4_mcu.motor:
              motor: tray
              direction: open
              speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
              mode: time
              timeout: 80
    turn_off_action:
      - if:
          all:
            - binary_sensor.is_off: cover
            - binary_sensor.is_off: bin
          then:
            pkt4_mcu.motor:
              motor: tray
              direction: close
              speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
              mode: time
              timeout: 80

  - platform: template
    id: motor_drum_down
    name: Drum Down
    icon: mdi:horizontal-rotate-counterclockwise
    entity_category: diagnostic
    optimistic: true
    restore_mode: disabled
    turn_on_action:
      - if:
          all:
            - binary_sensor.is_off: approach
            - binary_sensor.is_off: pet_inside
            - binary_sensor.is_off: cover
            - binary_sensor.is_off: drum_down
            - binary_sensor.is_off: bin
          then:
            - globals.set:
                id: level_needed
                value: 'true'
            - pkt4_mcu.motor:
                motor: drum
                direction: down
                speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                mode: time
                timeout: 1000
          else:
            - delay: 0s
            - switch.turn_off: motor_drum_down
    turn_off_action:
      pkt4_mcu.motor:
        motor: drum
        mode: stop

  - platform: template
    id: motor_drum_up
    name: Drum Up
    icon: mdi:horizontal-rotate-clockwise
    entity_category: diagnostic
    optimistic: true
    restore_mode: disabled
    turn_on_action:
      - if:
          all:
            - binary_sensor.is_off: approach
            - binary_sensor.is_off: pet_inside
            - binary_sensor.is_off: cover
            - binary_sensor.is_off: drum_up
            - binary_sensor.is_off: bin
          then:
            pkt4_mcu.motor:
              motor: drum
              direction: up
              speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
              mode: time
              timeout: 1000
          else:
            - delay: 0s
            - switch.turn_off: motor_drum_up
    turn_off_action:
      pkt4_mcu.motor:
        motor: drum
        mode: stop

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Configuration Numbers
# ═══════════════════════════════════════════════════════════════════════════════

number:
  # --- Cleaning Settings ---
  - platform: template
    id: clean_after
    name: Clean After
    icon: mdi:cookie-clock-outline
    entity_category: config
    unit_of_measurement: min
    mode: box
    min_value: 1
    max_value: 60
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 1

  - platform: template
    id: clean_threshold
    name: Clean Threshold
    icon: mdi:hydraulic-oil-level
    entity_category: config
    unit_of_measurement: g
    mode: box
    min_value: 10
    max_value: 100
    step: 5
    optimistic: true
    restore_value: true
    initial_value: 25

  - platform: template
    id: clean_times
    name: Clean Times
    icon: mdi:repeat-variant
    entity_category: config
    min_value: 1
    max_value: 5
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 1

  # --- Pet Settings ---
  - platform: template
    id: pet_threshold
    name: Pet Threshold
    icon: mdi:paw
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.10
    max_value: 10.00
    step: 0.10
    optimistic: true
    restore_value: true
    initial_value: 1.00

  # --- Litter Settings ---
  - platform: template
    id: litter_threshold
    name: Litter Threshold
    icon: mdi:pail
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 1.00
    max_value: 5.00
    step: 0.10
    optimistic: true
    restore_value: true
    initial_value: 2.00

  - platform: template
    id: tray_capacity
    name: Tray Capacity
    icon: mdi:tray-arrow-down
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.10
    max_value: 2.00
    step: 0.10
    optimistic: true
    restore_value: true
    initial_value: 1.00

  # --- Weight Calibration ---
  - platform: template
    name: Weight Calibration
    icon: mdi:scale-balance
    entity_category: config
    mode: box
    min_value: 0
    max_value: 10
    step: 0.01
    initial_value: NaN
    update_interval: never
    set_action:
      - if:
          condition:
            binary_sensor.is_off: cover
          then:
            globals.set:
              id: weight_scale
              value: !lambda return ((float)x / (id(weight).raw_state - id(weight_zero)));

  # --- Quiet Mode Settings ---
  - platform: template
    id: quiet_start_hour
    name: Quiet Start Hour
    icon: mdi:weather-night
    entity_category: config
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 22

  - platform: template
    id: quiet_end_hour
    name: Quiet End Hour
    icon: mdi:weather-sunny
    entity_category: config
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: true
    initial_value: 7

  # --- Pet Weight Ranges (Pet 1) ---
  - platform: template
    name: Pet 1 Min Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 1.0
    set_action:
      globals.set:
        id: pet_weight_min
        value: !lambda |- 
          auto arr = id(pet_weight_min);
          arr[0] = x;
          return arr;

  - platform: template
    name: Pet 1 Max Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 3.0
    set_action:
      globals.set:
        id: pet_weight_max
        value: !lambda |-
          auto arr = id(pet_weight_max);
          arr[0] = x;
          return arr;

  # --- Pet Weight Ranges (Pet 2) ---
  - platform: template
    name: Pet 2 Min Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 3.0
    set_action:
      globals.set:
        id: pet_weight_min
        value: !lambda |-
          auto arr = id(pet_weight_min);
          arr[1] = x;
          return arr;

  - platform: template
    name: Pet 2 Max Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 5.0
    set_action:
      globals.set:
        id: pet_weight_max
        value: !lambda |-
          auto arr = id(pet_weight_max);
          arr[1] = x;
          return arr;

  # --- Pet Weight Ranges (Pet 3) ---
  - platform: template
    name: Pet 3 Min Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 5.0
    disabled_by_default: true
    set_action:
      globals.set:
        id: pet_weight_min
        value: !lambda |-
          auto arr = id(pet_weight_min);
          arr[2] = x;
          return arr;

  - platform: template
    name: Pet 3 Max Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 7.0
    disabled_by_default: true
    set_action:
      globals.set:
        id: pet_weight_max
        value: !lambda |-
          auto arr = id(pet_weight_max);
          arr[2] = x;
          return arr;

  # --- Pet Weight Ranges (Pet 4) ---
  - platform: template
    name: Pet 4 Min Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 7.0
    disabled_by_default: true
    set_action:
      globals.set:
        id: pet_weight_min
        value: !lambda |-
          auto arr = id(pet_weight_min);
          arr[3] = x;
          return arr;

  - platform: template
    name: Pet 4 Max Weight
    icon: mdi:weight
    entity_category: config
    unit_of_measurement: kg
    mode: box
    min_value: 0.5
    max_value: 15.0
    step: 0.1
    optimistic: true
    restore_value: true
    initial_value: 15.0
    disabled_by_default: true
    set_action:
      globals.set:
        id: pet_weight_max
        value: !lambda |-
          auto arr = id(pet_weight_max);
          arr[3] = x;
          return arr;

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Text Inputs (Pet Names)
# ═══════════════════════════════════════════════════════════════════════════════

text:
  - platform: template
    id: pet_1_name
    name: Pet 1 Name
    icon: mdi:cat
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "Pet 1"
    min_length: 1
    max_length: 20
    mode: text

  - platform: template
    id: pet_2_name
    name: Pet 2 Name
    icon: mdi:cat
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "Pet 2"
    min_length: 1
    max_length: 20
    mode: text

  - platform: template
    id: pet_3_name
    name: Pet 3 Name
    icon: mdi:cat
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "Pet 3"
    min_length: 1
    max_length: 20
    mode: text

  - platform: template
    id: pet_4_name
    name: Pet 4 Name
    icon: mdi:cat
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "Pet 4"
    min_length: 1
    max_length: 20
    mode: text

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Text Sensors (Status & Events)
# ═══════════════════════════════════════════════════════════════════════════════

text_sensor:
  - platform: template
    id: current_pet_name
    name: Current Pet Name
    icon: mdi:paw
    update_interval: 1s
    lambda: |-
      int pet = id(current_pet_id);
      if (pet == 0) return id(pet_1_name).state;
      if (pet == 1) return id(pet_2_name).state;
      if (pet == 2) return id(pet_3_name).state;
      if (pet == 3) return id(pet_4_name).state;
      return std::string("None");

  - platform: template
    id: last_pet_event
    name: Last Pet Event
    icon: mdi:history
    update_interval: never

  - platform: template
    id: litter_box_status
    name: Status
    icon: mdi:information
    update_interval: 5s
    lambda: |-
      if (id(ota_state)) return std::string("Updating...");
      if (id(clean).state) return std::string("Cleaning");
      if (id(maintenance).state) return std::string("Maintenance");
      if (id(pet_inside).state) {
        int pet = id(current_pet_id);
        if (pet == 0) return std::string("In use: ") + id(pet_1_name).state;
        if (pet == 1) return std::string("In use: ") + id(pet_2_name).state;
        if (pet == 2) return std::string("In use: ") + id(pet_3_name).state;
        if (pet == 3) return std::string("In use: ") + id(pet_4_name).state;
        return std::string("In use");
      }
      if (id(level_needed)) return std::string("Leveling");
      if (id(clean_pending).state) return std::string("Clean pending");
      if (id(is_quiet_time)) return std::string("Quiet mode");
      if (id(tray_full).state) return std::string("Tray full!");
      if (id(litter_low).state) return std::string("Litter low");
      if (id(cover).state) return std::string("Cover open");
      if (id(bin).state) return std::string("Bin removed");
      return std::string("Ready");

  - platform: wifi_info
    ip_address:
      name: IP Address
      icon: mdi:ip-network
      entity_category: diagnostic
    mac_address:
      name: MAC Address
      icon: mdi:network
      entity_category: diagnostic
      disabled_by_default: true

  - platform: version
    name: Firmware Version
    icon: mdi:tag
    entity_category: diagnostic

# ═══════════════════════════════════════════════════════════════════════════════
# SECTION: Scripts
# ═══════════════════════════════════════════════════════════════════════════════

script:
  # --- Motor Control Scripts ---
  - id: level_if_needed
    then:
      - delay: 0s  # yield
      - if:
          all:
            - lambda: return id(level_needed);
            - binary_sensor.is_off: cover
            - not:
                binary_sensor.is_on: tray
          then:
            pkt4_mcu.motor:
              motor: tray
              direction: open
              speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
              mode: time
              timeout: 80
          else:
            - if:
                all:
                  - lambda: return !id(level_needed);
                  - switch.is_off: clean
                  - switch.is_off: maintenance
                  - binary_sensor.is_off: drum_level
                  - binary_sensor.is_off: cover
                  - binary_sensor.is_on: tray
                  - binary_sensor.is_off: bin
                then:
                  pkt4_mcu.motor:
                    motor: tray
                    direction: close
                    speed: 5
                    mode: time
                    timeout: 80
                else:
                  - if:
                      any:
                        - switch.is_on: clean
                        - lambda: return id(level_needed);
                      then:
                        - if:
                            all:
                              - binary_sensor.is_off: approach
                              - binary_sensor.is_off: pet_inside
                              - binary_sensor.is_off: cover
                              - binary_sensor.is_off: drum_down
                              - binary_sensor.is_off: bin
                              - binary_sensor.is_on: tray
                              - switch.is_off: maintenance
                            then:
                              pkt4_mcu.motor:
                                motor: drum
                                direction: down
                                speed: !lambda "return id(is_quiet_time) ? 50 : 100;"
                                mode: time
                                timeout: 1000

  - id: emergency_stop
    then:
      - pkt4_mcu.motor:
          motor: drum
          mode: stop
      - if:
          all:
            - switch.is_off: clean
            - switch.is_off: maintenance
            - binary_sensor.is_on: drum_level
          then:
            globals.set:
              id: level_needed
              value: 'true'

  # --- Auto Clean Scripts ---
  - id: clean_if_needed
    mode: restart
    then:
      - delay: !lambda return id(clean_after).state * 60000;
      - if:
          all:
            - switch.is_off: clean
            - switch.is_off: maintenance
            - binary_sensor.is_off: pet_inside
            - any:
                - all:
                    - switch.is_on: do_auto_clean
                    - lambda: return id(pet_weight).state * 1000 > id(clean_threshold).state;
                - lambda: return (id(cleans_left) > 0 && id(cleans_left) < id(clean_times).state);
          then:
            - if:
                condition:
                  lambda: return id(is_quiet_time);
                then:
                  # Defer clean during quiet hours
                  - globals.set:
                      id: deferred_cleans
                      value: !lambda return id(deferred_cleans) + 1;
                else:
                  switch.turn_on: clean
          else:
            - globals.set:
                id: cleans_left
                value: '0'
            - script.execute: level_if_needed

  - id: auto_clean
    then:
      - if:
          all:
            - switch.is_on: do_auto_clean
            - switch.is_off: clean
            - switch.is_off: maintenance
            - binary_sensor.is_off: pet_inside
            - binary_sensor.is_off: drum_level
            - binary_sensor.is_off: tray_full
            - lambda: return id(cleans_left) > 0;
          then:
            - script.execute: clean_if_needed
            - globals.set:
                id: cleans_left
                value: !lambda return id(cleans_left) - 1;
          else:
            script.execute: level_if_needed

  - id: process_deferred_cleans
    mode: single  # Prevent multiple concurrent executions
    then:
      # Once started, process ALL deferred cleans regardless of quiet time changes
      # (quiet time only defers NEW cleans, doesn't interrupt processing)
      - while:
          condition:
            lambda: return id(deferred_cleans) > 0;
          then:
            - switch.turn_on: clean
            - wait_until:
                switch.is_off: clean
            - globals.set:
                id: deferred_cleans
                value: !lambda return id(deferred_cleans) - 1;
            - if:
                condition:
                  lambda: return id(deferred_cleans) > 0;
                then:
                  - delay: 60s  # Wait between deferred cleans (skip delay after last one)

  # --- Pet Tracking Scripts ---
  - id: pet_entered
    then:
      - lambda: |-
          float weight = id(pet_weight).state;
          int detected_pet = -1;
          
          // Find matching pet by weight range
          for (int i = 0; i < 4; i++) {
            if (weight >= id(pet_weight_min)[i] && weight <= id(pet_weight_max)[i]) {
              detected_pet = i;
              break;
            }
          }
          
          if (detected_pet >= 0) {
            id(current_pet_id) = detected_pet;
            id(visit_start_time) = millis();
            
            // Get pet name for event
            std::string pet_name;
            if (detected_pet == 0) pet_name = id(pet_1_name).state;
            else if (detected_pet == 1) pet_name = id(pet_2_name).state;
            else if (detected_pet == 2) pet_name = id(pet_3_name).state;
            else if (detected_pet == 3) pet_name = id(pet_4_name).state;
            
            // Publish event for HA automations
            char buf[64];
            snprintf(buf, sizeof(buf), "%s entered (%.2f kg)", pet_name.c_str(), weight);
            id(last_pet_event).publish_state(buf);
            
            ESP_LOGI("pet", "Pet %d (%s) entered (weight: %.2f kg)", detected_pet + 1, pet_name.c_str(), weight);
          } else {
            id(current_pet_id) = -1;
            
            // Unknown pet event
            char buf[64];
            snprintf(buf, sizeof(buf), "Unknown pet entered (%.2f kg)", weight);
            id(last_pet_event).publish_state(buf);
            
            ESP_LOGW("pet", "Unknown pet weight: %.2f kg", weight);
          }
      # Fire HA event for automations
      - homeassistant.event:
          event: esphome.petkit_pet_entered
          data:
            pet_id: !lambda return id(current_pet_id) + 1;
            pet_name: !lambda |-
              int pet = id(current_pet_id);
              if (pet == 0) return id(pet_1_name).state;
              if (pet == 1) return id(pet_2_name).state;
              if (pet == 2) return id(pet_3_name).state;
              if (pet == 3) return id(pet_4_name).state;
              return std::string("Unknown");
            weight: !lambda return id(pet_weight).state;

  - id: pet_exited
    then:
      # Store values before clearing for HA event
      - lambda: |-
          int pet = id(current_pet_id);
          if (pet >= 0 && pet < 4) {
            // Record visit
            id(pet_visit_count)[pet]++;
            id(pet_visits_today)[pet]++;
            
            // Update weight statistics using stored value (pet_mass is invalid after exit)
            float weight = id(last_valid_pet_mass);
            if (weight > 0.1f) {
              id(pet_last_weight)[pet] = weight;
              id(pet_weight_sum)[pet] += weight;
              id(pet_weight_count)[pet]++;
            }
            
            // Get pet name for event
            std::string pet_name;
            if (pet == 0) pet_name = id(pet_1_name).state;
            else if (pet == 1) pet_name = id(pet_2_name).state;
            else if (pet == 2) pet_name = id(pet_3_name).state;
            else if (pet == 3) pet_name = id(pet_4_name).state;
            
            unsigned long duration = (millis() - id(visit_start_time)) / 1000;
            
            // Publish event for HA automations
            char buf[80];
            snprintf(buf, sizeof(buf), "%s finished (%lu min %lu s, %.2f kg)", 
                     pet_name.c_str(), duration / 60, duration % 60, weight);
            id(last_pet_event).publish_state(buf);
            
            ESP_LOGI("pet", "Pet %d (%s) exited (duration: %lu s, weight: %.2f kg)", 
                     pet + 1, pet_name.c_str(), duration, weight);
          } else {
            // Unknown pet exited
            id(last_pet_event).publish_state("Unknown pet finished");
          }
      # Fire HA event for automations (before clearing pet_id)
      - homeassistant.event:
          event: esphome.petkit_pet_exited
          data:
            pet_id: !lambda return id(current_pet_id) + 1;
            pet_name: !lambda |-
              int pet = id(current_pet_id);
              if (pet == 0) return id(pet_1_name).state;
              if (pet == 1) return id(pet_2_name).state;
              if (pet == 2) return id(pet_3_name).state;
              if (pet == 3) return id(pet_4_name).state;
              return std::string("Unknown");
            weight: !lambda return id(last_valid_pet_mass);
            duration_seconds: !lambda return (millis() - id(visit_start_time)) / 1000;
      # Clear state for next visit
      - globals.set:
          id: current_pet_id
          value: '-1'
      - globals.set:
          id: last_valid_pet_mass
          value: '0.0f'

# ═══════════════════════════════════════════════════════════════════════════════
# End of Configuration
# by Sdore, 2024-25 | Refactored 2025
#   www.sdore.me
# ═══════════════════════════════════════════════════════════════════════════════
